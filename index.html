<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>연예 퀴즈팡</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- RSS 프록시 사전 연결 -->
  <link rel="preconnect" href="https://api.allorigins.win" crossorigin>
  <link rel="preconnect" href="https://api.codetabs.com" crossorigin>
  <link rel="preconnect" href="https://r.jina.ai" crossorigin>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Noto Sans KR', sans-serif; }
    .quiz-card { transition: all 0.3s ease; }
    .quiz-card:hover { transform: translateY(-2px); }
    .progress-bar { transition: width 0.5s ease; }
    .tooltip { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .medal-gold { color: #FFD700; }
    .medal-silver { color: #C0C0C0; }
    .medal-bronze { color: #CD7F32; }
    .skeleton { position: relative; overflow: hidden; background: #f3f4f6; }
    .skeleton::after { content: ''; position: absolute; inset: 0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(0,0,0,.04), transparent); animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">
  <!-- 홈 화면 -->
  <div id="home-screen" class="container mx-auto px-4 py-8">
    <div class="text-center mb-12">
      <h1 class="text-5xl font-bold text-purple-800 mb-2">연예 퀴즈팡</h1>
      <p class="text-xl text-gray-600 opacity-80">기사 속 정답을 찾아라!</p>
    </div>

    <!-- 카테고리 -->
    <div class="max-w-4xl mx-auto mb-12">
      <div class="grid grid-cols-3 gap-6 mb-6">
        <button onclick="selectCategory('아이돌')" class="quiz-card bg-gradient-to-r from-pink-400 to-purple-500 text-white p-8 rounded-2xl shadow-lg hover:shadow-xl"><div class="text-3xl mb-2">🎤</div><div class="text-xl font-semibold">아이돌</div></button>
        <button onclick="selectCategory('드라마')" class="quiz-card bg-gradient-to-r from-blue-400 to-indigo-500 text-white p-8 rounded-2xl shadow-lg hover:shadow-xl"><div class="text-3xl mb-2">📺</div><div class="text-xl font-semibold">드라마</div></button>
        <button onclick="selectCategory('영화')" class="quiz-card bg-gradient-to-r from-green-400 to-teal-500 text-white p-8 rounded-2xl shadow-lg hover:shadow-xl"><div class="text-3xl mb-2">🎬</div><div class="text-xl font-semibold">영화</div></button>
      </div>
      <div class="grid grid-cols-3 gap-6">
        <button onclick="selectCategory('예능')" class="quiz-card bg-gradient-to-r from-orange-400 to-red-500 text-white p-8 rounded-2xl shadow-lg hover:shadow-xl"><div class="text-3xl mb-2">🎪</div><div class="text-xl font-semibold">예능</div></button>
        <button onclick="selectCategory('스타')" class="quiz-card bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-8 rounded-2xl shadow-lg hover:shadow-xl"><div class="text-3xl mb-2">⭐</div><div class="text-xl font-semibold">스타</div></button>
        <button onclick="selectCategory('해외')" class="quiz-card bg-gradient-to-r from-purple-400 to-pink-500 text-white p-8 rounded-2xl shadow-lg hover:shadow-xl"><div class="text-3xl mb-2">🌍</div><div class="text-xl font-semibold">해외</div></button>
      </div>
    </div>

    <!-- 누적 참여수 -->
    <div class="text-center mb-12">
      <div class="bg-white rounded-xl p-6 shadow-lg max-w-md mx-auto">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">누적 참여수</h3>
        <div class="text-3xl font-bold text-purple-600" id="total-participants">1,000명</div>
      </div>
    </div>

    <!-- 전체 랭킹 TOP 5 -->
    <div class="bg-white rounded-xl p-6 shadow-lg max-ww-2xl max-w-2xl mx-auto mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">🏆 전체 랭킹 TOP 5</h3>
      <div id="today-ranking"></div>
    </div>
  </div>

  <!-- 닉네임 입력 -->
  <div id="nickname-screen" class="hidden container mx-auto px-4 py-8">
    <div class="flex justify-start mb-6">
      <button onclick="goHome()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-colors">🏠 홈으로</button>
    </div>
    <div class="max-w-md mx-auto bg-white rounded-xl p-8 shadow-lg">
      <h2 class="text-2xl font-bold text-center mb-6 text-purple-800">닉네임을 입력해주세요</h2>
      <div class="mb-6">
        <input id="nickname-input" type="text" placeholder="닉네임을 입력하세요" class="w-full p-4 border-2 border-purple-200 rounded-lg focus:border-purple-500 focus:outline-none text-lg"/>
      </div>
      <button onclick="startQuiz()" class="w-full bg-purple-500 text-white py-4 rounded-lg text-lg font-semibold hover:bg-purple-600 transition-colors">퀴즈 시작하기</button>
    </div>
  </div>

  <!-- 퀴즈 풀기 -->
  <div id="quiz-screen" class="hidden container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-6">
      <button onclick="goHome()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-colors">🏠 홈으로</button>
      <h2 class="text-xl font-semibold text-purple-800" id="quiz-header">아이돌 퀴즈 - 닉네임</h2>
      <div></div>
    </div>

    <div class="mb-8">
      <div class="w-full bg-gray-200 rounded-full h-3">
        <div class="progress-bar bg-purple-500 h-3 rounded-full" id="progress-bar" style="width: 16.67%"></div>
      </div>
      <div class="text-center mt-2">
        <span class="text-sm text-gray-600 font-medium" id="progress-text">1/6</span>
      </div>
    </div>

    <div class="bg-white rounded-xl p-8 shadow-lg mb-6">
      <div class="flex items-start justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-800 flex-1" id="question-text">문제가 여기에 표시됩니다.</h3>
        <button onclick="showHint()" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg ml-4 transition-colors">💡 힌트보기</button>
      </div>
      <div class="space-y-3" id="options-container"></div>
    </div>

    <div id="answer-tooltip" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 px-6 py-3 rounded-lg text-white font-semibold text-lg z-50"></div>
  </div>

  <!-- 결과 화면 -->
  <div id="result-screen" class="hidden container mx-auto px-4 py-8">
    <div class="text-center mb-8">
      <h2 class="text-3xl font-bold text-purple-800 mb-4" id="result-title">아이돌 퀴즈 풀기 완료!</h2>
      <div class="text-2xl font-semibold text-gray-700 mb-2" id="result-score">닉네임님의 점수: 85점 (정답 5/6)</div>
      <div class="text-lg text-gray-600" id="result-message">훌륭해요! 연예계 소식에 관심이 많으시네요! 🌟</div>
    </div>

    <div class="flex justify-center space-x-4 mb-12">
      <button onclick="retryQuiz()" class="bg-purple-500 hover:bg-purple-600 text-white px-8 py-3 rounded-lg font-semibold transition-colors">다시 풀기</button>
      <button onclick="goHome()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition-colors">홈으로 가기</button>
    </div>

    <!-- 전체 랭킹 TOP 10 -->
    <div class="bg-white rounded-xl p-6 shadow-lg max-w-2xl mx-auto mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">🏆 전체 랭킹 TOP 10</h3>
      <div id="overall-ranking-10"></div>
    </div>

    <!-- 실시간 추천 뉴스 -->
    <div class="bg-white rounded-xl p-6 shadow-lg max-w-2xl mx-auto">
      <h3 class="text-xl font-bold text-gray-800 mb-4">📰 실시간 추천 뉴스</h3>
      <div id="news-container" class="space-y-4"></div>
    </div>
  </div>

  <!-- 관리자 로그인 -->
  <div id="admin-login-screen" class="hidden container mx-auto px-4 py-12">
    <div class="max-w-sm mx-auto bg-white rounded-xl p-8 shadow-lg">
      <h2 class="text-2xl font-bold text-center mb-6 text-purple-800">관리자 로그인</h2>
      <div class="space-y-4">
        <div><label class="block text-sm text-gray-700 mb-1">아이디</label><input id="admin-login-id" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="아이디"/></div>
        <div><label class="block text-sm text-gray-700 mb-1">비밀번호</label><input id="admin-login-pw" type="password" class="w-full p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="비밀번호"/></div>
        <button onclick="loginAdmin()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-colors">로그인</button>
        <button onclick="goHome()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-semibold transition-colors">홈으로</button>
      </div>
    </div>
  </div>

  <!-- 관리자 목록 -->
  <div id="admin-screen" class="hidden container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-3xl font-bold text-purple-800">관리자 페이지</h2>
        <div class="flex items-center gap-2">
          <button onclick="logoutAdmin()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded-lg transition-colors">로그아웃</button>
          <button onclick="goHome()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">홈으로</button>
        </div>
      </div>

      <div class="bg-white rounded-xl p-8 shadow-lg">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold">카테고리별 퀴즈 관리</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300">
            <thead>
              <tr class="bg-gray-50">
                <th class="border border-gray-300 px-4 py-3 text-left">카테고리</th>
                <th class="border border-gray-300 px-4 py-3 text-center">퀴즈 개수</th>
                <th class="border border-gray-300 px-4 py-3 text-center">최근 수정일시</th>
                <th class="border border-gray-300 px-4 py-3 text-center">작업</th>
              </tr>
            </thead>
            <tbody id="category-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 관리자 카테고리 업데이트 -->
  <div id="admin-create-screen" class="hidden container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-8">
        <h2 id="admin-create-title" class="text-3xl font-bold text-purple-800">퀴즈 업데이트</h2>
        <button onclick="showAdminList()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">뒤로가기</button>
      </div>

      <div class="bg-white rounded-xl p-8 shadow-lg">
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">퀴즈 데이터 (JSON only, 4지선다)</label>
          <textarea id="admin-quiz-json" rows="15" class="w-full p-3 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none font-mono text-sm"
placeholder='{
  "카테고리": "아이돌",
  "quizzes": [
    { "question": "문제1", "options": ["보기1","보기2","보기3","보기4"], "correctIndex": 0, "hintUrl": "https://...", "meta": {} },
    { "question": "문제2", "options": ["보기1","보기2","보기3","보기4"], "correctIndex": 1, "hintUrl": "https://...", "meta": {} },
    { "question": "문제3", "options": ["보기1","보기2","보기3","보기4"], "correctIndex": 2, "hintUrl": "https://...", "meta": {} },
    { "question": "문제4", "options": ["보기1","보기2","보기3","보기4"], "correctIndex": 3, "hintUrl": "https://...", "meta": {} },
    { "question": "문제5", "options": ["보기1","보기2","보기3","보기4"], "correctIndex": 0, "hintUrl": "https://...", "meta": {} },
    { "question": "문제6", "options": ["보기1","보기2","보기3","보기4"], "correctIndex": 1, "hintUrl": "https://...", "meta": {} }
  ]
}'></textarea>
          <p class="text-sm text-gray-500 mt-2">※ JSON에 카테고리가 없어도, 목록에서 선택한 카테고리로 업데이트됩니다.</p>
        </div>

        <div class="flex justify-end space-x-4">
          <button onclick="validateQuizJson()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">검증</button>
          <button onclick="previewQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">미리보기</button>
          <button onclick="registerQuizGroup()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">등록하기</button>
        </div>

        <div id="preview-area" class="hidden mt-8 p-6 bg-gray-50 rounded-lg">
          <h4 class="text-lg font-semibold mb-4">퀴즈 미리보기</h4>
          <div id="preview-content"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 푸터 -->
  <footer class="bg-white border-t mt-16 py-6">
    <div class="container mx-auto px-4 text-center">
      <div class="text-lg font-semibold text-gray-800">SBS연예뉴스</div>
      <div class="text-sm text-gray-600">@yaongc</div>
      <div id="admin-button-container" class="mt-2">
        <!-- 요청: 기존보다 조금 더 흐리게 -->
        <button onclick="showAdminLogin()" class="text-gray-500 text-xs opacity-55 hover:opacity-90 font-semibold underline underline-offset-2 tracking-wide">admin</button>
      </div>
    </div>
  </footer>

  <script>
    /* ---------------- 공통 상태 ---------------- */
    let currentCategory = '';
    let currentNickname = '';
    let currentQuizIndex = 0;
    let totalParticipants = 1000;

    const scoringWeights = [17,17,17,17,16,16];
    let totalScore = 0;
    let correctCount = 0;

    const PARTICIPANTS_KEY = 'ent_participants_v1';
    function loadParticipants(){ try { return JSON.parse(localStorage.getItem(PARTICIPANTS_KEY)||'[]'); } catch { return []; } }
    function saveParticipant(rec){ const l=loadParticipants(); l.push(rec); localStorage.setItem(PARTICIPANTS_KEY, JSON.stringify(l)); }
    function getSeoulDateString(ts=Date.now()){ return new Date(ts).toLocaleDateString('sv-SE',{timeZone:'Asia/Seoul'}); }

    // 관리자 로그인(해시)
    const ADMIN_HASH = '2171ec0b29addbdd39bb33cda59477e88864561275ed1a33f357de2bfb013e13'; // sbsent|momo1234|ent-admin-v1
    function isAuthed(){ return sessionStorage.getItem('adminAuthed')==='1'; }
    function logoutAdmin(){ sessionStorage.removeItem('adminAuthed'); alert('로그아웃되었습니다.'); goHome(); }
    async function loginAdmin(){
      const id=(document.getElementById('admin-login-id').value||'').trim();
      const pw=(document.getElementById('admin-login-pw').value||'').trim();
      if(!id||!pw){ alert('아이디와 비밀번호를 입력하세요.'); return; }
      const txt=`${id}|${pw}|ent-admin-v1`;
      const enc=new TextEncoder().encode(txt);
      const buf=await crypto.subtle.digest('SHA-256', enc);
      const hashHex=Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      if(hashHex===ADMIN_HASH){ sessionStorage.setItem('adminAuthed','1'); showAdminPage(); }
      else { alert('아이디 또는 비밀번호가 올바르지 않습니다.'); }
    }

    /* ---------------- 샘플 퀴즈 데이터 ---------------- */
    const quizData = {
      '아이돌': [
        { id:1, question:'BTS의 리더는 누구인가요?', options:['RM','진','슈가','J-Hope'], correct:0, hint:'https://ent.sbs.co.kr', active:true, registrationDate:'2024-01-01T00:00:00.000Z' },
        { id:2, question:'블랙핑크의 멤버가 아닌 사람은?', options:['지수','제니','로제','아이린'], correct:3, hint:'https://ent.sbs.co.kr', active:true, registrationDate:'2024-01-02T00:00:00.000Z' },
        { id:3, question:'NewJeans의 데뷔곡은?', options:['Attention','Hype Boy','Cookie','Hurt'], correct:0, hint:'https://ent.sbs.co.kr', active:true, registrationDate:'2024-01-03T00:00:00.000Z' },
        { id:4, question:'IVE의 리더는 누구인가요?', options:['안유진','가을','레이','리즈'], correct:0, hint:'https://ent.sbs.co.kr', active:true, registrationDate:'2024-01-04T00:00:00.000Z' },
        { id:5, question:'aespa의 소속사는?', options:['JYP','SM','YG','HYBE'], correct:1, hint:'https://ent.sbs.co.kr', active:true, registrationDate:'2024-01-05T00:00:00.000Z' },
        { id:6, question:'(여자)아이들의 리더는?', options:['미연','민니','소연','우기'], correct:2, hint:'https://ent.sbs.co.kr', active:true, registrationDate:'2024-01-06T00:00:00.000Z' }
      ],
      '드라마': [
        { question:'2023년 최고 시청률을 기록한 드라마는?', options:['더 글로리','이상한 변호사 우영우','재벌집 막내아들','슬의생2'], correct:2, hint:'https://ent.sbs.co.kr' },
        { question:'박서준이 주연한 드라마가 아닌 것은?', options:['이태원 클라쓰','김비서가 왜 그럴까','쌈 마이웨이','사랑의 불시착'], correct:3, hint:'https://ent.sbs.co.kr' },
        { question:'SKY 캐슬의 배경이 되는 지역은?', options:['강남구','서초구','송파구','강서구'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'오징어 게임의 주인공 이름은?', options:['기훈','상우','덕수','일남'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'사랑의 불시착에서 현빈의 직업은?', options:['의사','군인','사업가','변호사'], correct:1, hint:'https://ent.sbs.co.kr' },
        { question:'펜트하우스의 배경이 되는 아파트 이름은?', options:['헤라팰리스','올림푸스','아테나','제우스'], correct:0, hint:'https://ent.sbs.co.kr' }
      ],
      '영화': [
        { question:'기생충의 감독은?', options:['봉준호','박찬욱','김지운','이창동'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'2023년 한국 영화 관객수 1위는?', options:['범죄도시3','스즈메의 문단속','가디언즈 오브 갤럭시3','분노의 질주10'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'마동석이 출연하지 않은 영화는?', options:['범죄도시','부산행','악인전','타짜3'], correct:3, hint:'https://ent.sbs.co.kr' },
        { question:'칸 영화제 황금종려상을 받은 한국 영화는?', options:['올드보이','기생충','아가씨','버닝'], correct:1, hint:'https://ent.sbs.co.kr' },
        { question:'송강호가 출연하지 않은 영화는?', options:['기생충','괴물','살인의 추억','신과함께'], correct:3, hint:'https://ent.sbs.co.kr' },
        { question:'박찬욱 감독의 작품이 아닌 것은?', options:['올드보이','아가씨','헤어질 결심','곡성'], correct:3, hint:'https://ent.sbs.co.kr' }
      ],
      '예능': [
        { question:'런닝맨의 MC가 아닌 사람은?', options:['유재석','김종국','송지효','강호동'], correct:3, hint:'https://ent.sbs.co.kr' },
        { question:'무한도전의 마지막 방송은 언제?', options:['2017년','2018년','2019년','2020년'], correct:1, hint:'https://ent.sbs.co.kr' },
        { question:'1박2일의 현재 시즌은?', options:['시즌3','시즌4','시즌5','시즌6'], correct:1, hint:'https://ent.sbs.co.kr' },
        { question:'나 혼자 산다의 방송사는?', options:['KBS','SBS','MBC','tvN'], correct:2, hint:'https://ent.sbs.co.kr' },
        { question:'유퀴즈 온 더 블럭의 MC는?', options:['유재석, 조세호','유재석, 이광수','유재석, 하하','유재석, 박명수'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'골목식당의 MC는?', options:['백종원','이연복','최현석','김풍'], correct:0, hint:'https://ent.sbs.co.kr' }
      ],
      '스타': [
        { question:'2023년 가장 화제가 된 연예인 커플은?', options:['현빈-손예진','송중기-송혜교','이민호-김고은','박서준-박민영'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'최근 해외 진출로 주목받는 배우는?', options:['이정재','박서준','송강호','공유'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'2023년 가장 많은 광고 모델을 한 연예인은?', options:['아이유','박보검','송혜교','전지현'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'최근 SNS 팔로워 수가 급증한 스타는?', options:['제니','수지','태연','아이린'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'2023년 가장 화제가 된 연예인 결혼식은?', options:['이승기-이다인','조정석-거미','김우빈-신민아','이종석-한효주'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'최근 패션 아이콘으로 주목받는 스타는?', options:['제니','크리스탈','수지','아이유'], correct:0, hint:'https://ent.sbs.co.kr' }
      ],
      '해외': [
        { question:'2023년 아카데미 작품상을 받은 영화는?', options:['에브리씽 에브리웨어 올 앳 원스','탑건: 매버릭','아바타: 물의 길','바빌론'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'테일러 스위프트의 2023년 투어 이름은?', options:['Eras Tour','Reputation Tour','Lover Tour','Folklore Tour'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'2023년 가장 화제가 된 할리우드 커플은?', options:['트래비스 켈시-테일러 스위프트','톰 홀랜드-젠데이아','티모시 샬라메-카일리 제너','레오나르도 디카프리오-지지 하디드'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'넷플릭스 오리지널 중 2023년 최고 화제작은?', options:['웬즈데이','스트레인저 씽즈4','브리저튼3','더 크라운6'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'2023년 빌보드 올해의 아티스트는?', options:['테일러 스위프트','해리 스타일스','배드 버니','올리비아 로드리고'], correct:0, hint:'https://ent.sbs.co.kr' },
        { question:'마블 시네마틱 유니버스의 2023년 작품은?', options:['가디언즈 오브 갤럭시 Vol.3','앤트맨과 와스프: 퀀텀매니아','더 마블스','모든 것'], correct:3, hint:'https://ent.sbs.co.kr' }
      ]
    };

    /* ---------------- 화면 전환 (async) ---------------- */
    async function showScreen(screenId){
      const screens=['home-screen','nickname-screen','quiz-screen','result-screen','admin-login-screen','admin-screen','admin-create-screen'];
      screens.forEach(id=>document.getElementById(id).classList.add('hidden'));
      document.getElementById(screenId).classList.remove('hidden');

      if(screenId==='home-screen'){
        document.getElementById('admin-button-container').style.display='block';
        renderTodayRanking('today-ranking');
      }

      if(screenId==='result-screen'){
        renderTodayRanking('overall-ranking-10', 10);

        // 1) 캐시 즉시 렌더
        const mem = loadCachedNews();
        if (mem && mem.length) {
          renderNewsList('news-container', mem);
        } else {
          newsSkeleton('news-container', 5);
        }

        // 2) 퀴즈 시작 시 프리패치된 Promise 최대 1200ms 대기 후 반영
        try {
          if (NEWS_PROMISE) {
            const items = await promiseWithTimeout(NEWS_PROMISE, 1200);
            if (Array.isArray(items) && items.length) renderNewsList('news-container', items);
          }
        } catch(e) {}

        // 3) 최신 데이터로 조용히 갱신
        ensureFreshRSS('news-container', 5);
      }
    }

    function selectCategory(category){ currentCategory=category; showScreen('nickname-screen'); }

    function startQuiz(){
      const nickname=document.getElementById('nickname-input').value.trim();
      if(!nickname){ alert('닉네임을 입력해주세요!'); return; }
      currentNickname=nickname; currentQuizIndex=0; totalScore=0; correctCount=0;

      // 결과 화면 즉시 노출 위한 사전 프리패치
      NEWS_PROMISE = warmRSSCache();

      showScreen('quiz-screen'); updateQuizHeader(); loadQuestion();
    }

    function goHome(){ showScreen('home-screen'); document.getElementById('nickname-input').value=''; }

    function showAdminLogin(){
      if(isAuthed()){ showAdminPage(); return; }
      showScreen('admin-login-screen'); document.getElementById('admin-button-container').style.display='none';
    }
    function showAdminPage(){
      if(!isAuthed()){ showAdminLogin(); return; }
      showScreen('admin-screen'); document.getElementById('admin-button-container').style.display='none'; renderCategoryTable();
    }

    /* ---------------- 퀴즈 진행 ---------------- */
    function updateQuizHeader(){ document.getElementById('quiz-header').textContent=`${currentCategory} 퀴즈 - ${currentNickname}님`; }

    function loadQuestion(){
      const quiz=quizData[currentCategory][currentQuizIndex];
      document.getElementById('question-text').textContent=quiz.question;
      document.getElementById('progress-text').textContent=`${currentQuizIndex+1}/6`;
      document.getElementById('progress-bar').style.width=`${((currentQuizIndex+1)/6)*100}%`;

      const optionsContainer=document.getElementById('options-container'); optionsContainer.innerHTML='';
      quiz.options.forEach((opt,idx)=>{
        const btn=document.createElement('button');
        btn.className='w-full p-4 text-left bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors border-2 border-transparent hover:border-purple-200';
        btn.textContent=`${idx+1}. ${opt}`;
        btn.onclick=()=>selectAnswer(idx);
        optionsContainer.appendChild(btn);
      });
    }

    function selectAnswer(sel){
      const quiz=quizData[currentCategory][currentQuizIndex];
      const isCorrect=sel===quiz.correct;
      if(isCorrect){ totalScore+=scoringWeights[currentQuizIndex]; correctCount+=1; showTooltip('정답!','bg-green-500'); }
      else { showTooltip(`오답! 정답: ${quiz.options[quiz.correct]}`,'bg-red-500'); }

      const buttons=document.querySelectorAll('#options-container button');
      buttons.forEach((b,i)=>{ if(i===quiz.correct) b.classList.add('bg-green-200','border-green-400'); else if(i===sel&&!isCorrect) b.classList.add('bg-red-200','border-red-400'); b.disabled=true; });

      setTimeout(()=>{ currentQuizIndex++; if(currentQuizIndex<6) loadQuestion(); else showResult(); }, 1200);
    }

    function showTooltip(msg,bg){ const t=document.getElementById('answer-tooltip'); t.textContent=msg; t.className=`tooltip fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 px-6 py-3 rounded-lg text-white font-semibold text-lg z-50 ${bg}`; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),700); }
    function showHint(){ const quiz=quizData[currentCategory][currentQuizIndex]; window.open(quiz.hint,'_blank'); }

    function showResult(){
      const roundedScore=Math.min(100, Math.max(0, Math.round(totalScore/5)*5));
      totalParticipants++; document.getElementById('total-participants').textContent=`${totalParticipants.toLocaleString()}명`;
      saveParticipant({ nickname: currentNickname, category: currentCategory, totalScore: roundedScore, ts: Date.now() });

      showScreen('result-screen');
      document.getElementById('result-title').textContent=`${currentCategory} 퀴즈 풀기 완료!`;
      document.getElementById('result-score').textContent=`${currentNickname}님의 점수: ${roundedScore}점 (정답 ${correctCount}/6)`;

      let m=''; if(roundedScore===100) m='완벽해요! 당신은 진정한 연예계 전문가네요! 🏆';
      else if(roundedScore>=70) m='훌륭해요! 연예계 소식에 관심이 많으시네요! 🌟';
      else if(roundedScore>=40) m='괜찮아요! 조금만 더 관심을 가져보세요! 👍';
      else m='아쉬워요! 연예뉴스를 더 많이 보시는 걸 추천해요! 📺';
      document.getElementById('result-message').textContent=m;

      renderTodayRanking('overall-ranking-10', 10);
    }

    function retryQuiz(){ currentQuizIndex=0; totalScore=0; correctCount=0; showScreen('quiz-screen'); updateQuizHeader(); loadQuestion(); }
    function openNews(url){ window.open(url,'_blank'); }

    /* ---------------- 랭킹 ---------------- */
    function renderTodayRanking(containerId, limit=5){
      const wrap=document.getElementById(containerId); if(!wrap) return;
      const list=loadParticipants(); const today=getSeoulDateString(); const banned=new Set(['모모','ㅇㄹㅇ']);
      const todays=list.filter(r=>getSeoulDateString(r.ts)===today).filter(r=>!banned.has(r.nickname));

      const best=new Map();
      todays.forEach(r=>{ const cur=best.get(r.nickname); if(!cur||r.totalScore>cur.totalScore||(r.totalScore===cur.totalScore&&r.ts<cur.ts)) best.set(r.nickname,r); });
      const top=Array.from(best.values()).sort((a,b)=>(b.totalScore-a.totalScore)||(a.ts-b.ts)).slice(0,limit);

      if(!top.length){ wrap.innerHTML=`<div class="text-center text-gray-500 py-6">아직 기록이 없습니다. 첫 랭킹의 주인공이 되어보세요!</div>`; return; }

      wrap.innerHTML='';
      top.forEach((r,i)=>{
        const row=document.createElement('div'); row.className=`grid grid-cols-3 gap-4 py-2 ${i<top.length-1?'border-b':''}`;
        const medal=i===0?'🥇':i===1?'🥈':i===2?'🥉':(i+1); const medalClass=i===0?'medal-gold':i===1?'medal-silver':i===2?'medal-bronze':'text-gray-500';
        row.innerHTML=`
          <div class="text-center"><span class="${medalClass} ${i<3?'text-2xl':''}">${medal}</span></div>
          <div class="text-center"><span class="font-semibold">${r.nickname}</span></div>
          <div class="text-center"><span class="text-purple-600 font-semibold">${r.totalScore}점 (${r.category})</span></div>
        `;
        wrap.appendChild(row);
      });
    }

    /* ---------------- 관리자 목록 ---------------- */
    function getLastModifiedOfCategory(cat){
      const list=quizData[cat]||[]; if(!list.length) return null;
      const latest=list.reduce((acc,q)=>{ const t=new Date(q.registrationDate||0).getTime(); return t>acc?t:acc; },0);
      return latest?new Date(latest):null;
    }
    function formatDateK(d){ if(!d) return '-'; const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${yyyy}.${mm}.${dd} ${hh}:${mi}`; }
    function renderCategoryTable(){
      const cats=['아이돌','드라마','영화','예능','스타','해외']; const tbody=document.getElementById('category-table'); tbody.innerHTML='';
      cats.forEach(cat=>{
        (quizData[cat]||[]).forEach((q,i)=>{ if(!q.id) q.id=2000+i; if(!q.registrationDate) q.registrationDate=new Date(Date.now()-i*1000).toISOString(); });
        const cnt=(quizData[cat]||[]).length; const last=getLastModifiedOfCategory(cat);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="border border-gray-300 px-4 py-3">${cat}</td>
          <td class="border border-gray-300 px-4 py-3 text-center">${cnt}개</td>
          <td class="border border-gray-300 px-4 py-3 text-center text-sm">${formatDateK(last)}</td>
          <td class="border border-gray-300 px-4 py-3 text-center">
            <button onclick="openCategoryUpdate('${cat}')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition-colors">수정</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ---------------- 카테고리 업데이트 ---------------- */
    let editingCategory=null;
    function openCategoryUpdate(cat){
      if(!isAuthed()){ showAdminLogin(); return; }
      editingCategory=cat; showScreen('admin-create-screen');
      document.getElementById('admin-create-title').textContent=`퀴즈 업데이트 - ${cat}`;

      // ✅ 기존 slice(0,2) 제거: 저장된 모든 퀴즈를 로드하고, 편집 화면에서는 최대 6개까지 표시
      const existingAll = (quizData[cat] || []).map(q => ({
        question: q.question,
        options: q.options,
        correctIndex: q.correct,
        hintUrl: q.hint || ''
      }));

      // 최대 6개까지만 사용(요구사항: 6문제 운영)
      let cur = existingAll.slice(0, 6);

      // 6개보다 적으면 더미로 채워서 항상 6개 보이도록
      while (cur.length < 6) {
        cur.push({
          question: '새 문제',
          options: ['보기1','보기2','보기3','보기4'],
          correctIndex: 0,
          hintUrl: ''
        });
      }

      document.getElementById('admin-quiz-json').value = JSON.stringify({ quizzes: cur }, null, 2);
      document.getElementById('preview-area').classList.add('hidden');
      window.scrollTo({ top:0, behavior:'smooth' });
    }

    let lastCreateParsed=null;
    function validateCreateJsonText(text){
      try{
        const parsed=JSON.parse(text);
        if(!parsed.category && parsed['카테고리']) parsed.category=parsed['카테고리'];
        if(!parsed.category && !editingCategory) return {ok:false,msg:'category 문자열이 없으면, 목록에서 카테고리를 먼저 선택해야 합니다.'};
        if(!parsed.quizzes||!Array.isArray(parsed.quizzes)||!parsed.quizzes.length) return {ok:false,msg:'quizzes 배열(1개 이상)이 필요합니다.'};
        for(let i=0;i<parsed.quizzes.length;i++){
          const q=parsed.quizzes[i];
          if(!q.question) return {ok:false,msg:`${i+1}번째 퀴즈: question이 필요합니다.`};
          if(!Array.isArray(q.options)||q.options.length!==4) return {ok:false,msg:`${i+1}번째 퀴즈: options는 4개여야 합니다.`};
          if(typeof q.correctIndex!=='number'||q.correctIndex<0||q.correctIndex>3) return {ok:false,msg:`${i+1}번째 퀴즈: correctIndex는 0~3입니다.`};
        }
        return {ok:true,data:parsed};
      }catch(e){ return {ok:false,msg:`JSON 형식 오류: ${e.message}`}; }
    }
    function showToast(m,ok=true){ const el=document.createElement('div'); el.className=`fixed top-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-md text-white z-50 ${ok?'bg-purple-600':'bg-red-500'}`; el.textContent=m; document.body.appendChild(el); setTimeout(()=>el.remove(),1500); }
    function showValidationTooltip(m,ok=true){ showToast(m,ok); }
    function validateQuizJson(){ const t=document.getElementById('admin-quiz-json').value; const r=validateCreateJsonText(t); if(r.ok) lastCreateParsed=r.data; else lastCreateParsed=null; showValidationTooltip(r.ok?'검증 통과!':r.msg, !!r.ok); return r.ok; }
    function previewQuiz(){
      if(!validateQuizJson()) return;
      const p=lastCreateParsed; const area=document.getElementById('preview-area'); const content=document.getElementById('preview-content'); content.innerHTML='';
      p.quizzes.forEach((q,idx)=>{ const d=document.createElement('div'); d.className='mb-6 p-4 border border-gray-300 rounded-lg'; d.innerHTML=`
        <h5 class="font-semibold mb-3">문제 ${idx+1}: ${q.question}</h5>
        <div class="space-y-2">${q.options.map((opt,i)=>`<div class="p-2 rounded ${i===q.correctIndex?'bg-green-100 border border-green-300':'bg-gray-50'}">${i+1}. ${opt} ${i===q.correctIndex?'(정답)':''}</div>`).join('')}</div>
        ${q.hintUrl?`<div class="text-xs text-gray-500 mt-2">힌트: ${q.hintUrl}</div>`:''}
      `; content.appendChild(d); }); area.classList.remove('hidden'); window.scrollTo({ top: area.offsetTop-80, behavior:'smooth' }); }
    function showAdminList(){ showScreen('admin-screen'); renderCategoryTable(); window.scrollTo({ top:0, behavior:'smooth' }); }
    function registerQuizGroup(){
      if(!validateQuizJson()) return;
      const p=lastCreateParsed; const category=p.category||editingCategory; if(!category){ showToast('카테고리를 찾을 수 없습니다.', false); return; }
      const regDate=new Date().toISOString();
      // 등록 시 전달된 quizzes를 모두 반영 (6개든 그 이상이든 저장 가능하지만 운영은 6개 기준)
      quizData[category]=p.quizzes.map((q,i)=>({ id:3000+i, question:q.question, options:q.options, correct:q.correctIndex, hint:q.hintUrl||'', active:true, registrationDate:regDate, meta:q.meta||{} }));
      lastCreateParsed=null; showAdminList(); showToast(`[${category}] 카테고리가 업데이트되었습니다!`);
    }

    /* ---------------- RSS 프리패치 → 즉시 렌더 ---------------- */
    const RSS_URL='https://ent.sbs.co.kr/news/xml/RSSFeed.do';
    const PROXY_ALLORIGINS_JSON='https://api.allorigins.win/get?url='+encodeURIComponent(RSS_URL); // JSON{ contents }
    const PROXY_ALLORIGINS_RAW='https://api.allorigins.win/raw?url='+encodeURIComponent(RSS_URL);  // 순수 텍스트
    const PROXY_CODETABS='https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(RSS_URL);
    const PROXY_JINA='https://r.jina.ai/http://ent.sbs.co.kr/news/xml/RSSFeed.do';

    const NEWS_CACHE_KEY='ent_news_cache_v1';
    const NEWS_TTL_MS=3*60*1000;

    let NEWS_MEM=null;
    let NEWS_MEM_TS=0;
    let NEWS_PROMISE=null; // 프리패치 프로미스

    function getMemNews(){ return (NEWS_MEM && (Date.now()-NEWS_MEM_TS<NEWS_TTL_MS)) ? NEWS_MEM : null; }
    function setMemNews(items){ NEWS_MEM=items; NEWS_MEM_TS=Date.now(); }
    function loadCachedNews(){
      const mem=getMemNews(); if(mem) return mem;
      try{ const raw=sessionStorage.getItem(NEWS_CACHE_KEY); if(!raw) return null;
        const {ts,items}=JSON.parse(raw); if(Date.now()-ts<NEWS_TTL_MS && Array.isArray(items) && items.length){ setMemNews(items); return items; }
      }catch{} return null;
    }
    function saveCachedNews(items){ try{ sessionStorage.setItem(NEWS_CACHE_KEY, JSON.stringify({ts:Date.now(),items})); setMemNews(items); }catch{} }

    function newsSkeleton(containerId,count=5){
      const box=document.getElementById(containerId); if(!box) return; box.innerHTML='';
      for(let i=0;i<count;i++){ const card=document.createElement('div'); card.className='p-4 rounded-lg border border-gray-200 skeleton'; card.style.height='52px'; box.appendChild(card); }
    }
    function renderNewsList(containerId, items){
      const box=document.getElementById(containerId); if(!box) return; box.innerHTML='';
      const list=items.slice(0,5); while(list.length<5){ list.push({ title:'연예계 소식 업데이트를 기다리는 중...', link:'https://ent.sbs.co.kr' }); }
      list.forEach(({title,link})=>{ const card=document.createElement('div'); card.className='p-4 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors border border-gray-200'; card.onclick=()=>openNews(link); card.innerHTML=`<div class="text-sm text-gray-800 font-medium leading-relaxed">${title}</div>`; box.appendChild(card); });
    }

    function parseMaybeJSONThenXML(text){
      // allorigins JSON 형태면 contents를 꺼내 XML 파싱
      try {
        const obj = JSON.parse(text);
        if (obj && typeof obj.contents === 'string') {
          return parseRSSItems(obj.contents, 5);
        }
      } catch(_) {
        // JSON 아니면 XML로 취급
      }
      return parseRSSItems(text, 5);
    }

    function parseRSSItems(xmlText, max=5){
      try{
        const doc=new DOMParser().parseFromString(xmlText,'text/xml');
        const items = Array.from(doc.querySelectorAll('item')).slice(0,max).map(it=>({
          title: it.querySelector('title')?.textContent?.trim() || '제목 없음',
          link: it.querySelector('link')?.textContent?.trim() || '#',
          pubDate: it.querySelector('pubDate')?.textContent?.trim() || ''
        }));
        return items;
      }catch{ return []; }
    }

    async function fetchText(url, ms=3000){
      const ctrl=new AbortController(); const timer=setTimeout(()=>ctrl.abort(), ms);
      try{
        const res=await fetch(url,{ signal: ctrl.signal, cache: 'no-store' });
        return await res.text();
      } finally { clearTimeout(timer); }
    }

    async function tryOne(fetcher){
      const text = await fetcher();
      const items = parseMaybeJSONThenXML(text);
      if (!items.length) throw new Error('No items');
      return items;
    }

    async function fetchRSSFast(){
      // 신뢰도 높은 allorigins JSON → raw → codetabs → jina 순
      const candidates = [
        ()=>fetchText(PROXY_ALLORIGINS_JSON, 2800),
        ()=>fetchText(PROXY_ALLORIGINS_RAW, 2800),
        ()=>fetchText(PROXY_CODETABS, 2800),
        ()=>fetchText(PROXY_JINA, 2800),
      ];
      for (const fn of candidates) {
        try { return await tryOne(fn); } catch(e) { /* 다음 후보로 */ }
      }
      return [];
    }

    async function warmRSSCache(){
      // 캐시가 신선하면 네트워크 패스
      const cached = loadCachedNews();
      if (cached) return cached;
      const items = await fetchRSSFast();
      if (items.length) saveCachedNews(items);
      return items;
    }

    async function ensureFreshRSS(containerId='news-container', fixedCount=5){
      const fresh = await fetchRSSFast();
      if (fresh.length) {
        const prev = getMemNews() || [];
        const changed = JSON.stringify(prev.map(i=>i.title)) !== JSON.stringify(fresh.map(i=>i.title));
        saveCachedNews(fresh);
        if (changed) renderNewsList(containerId, fresh);
      } else {
        if (!getMemNews()) renderNewsList(containerId, []); // 폴백
      }
    }

    function promiseWithTimeout(p, ms){
      return new Promise((resolve, reject)=>{
        const t=setTimeout(()=>reject(new Error('timeout')), ms);
        p.then(v=>{ clearTimeout(t); resolve(v); }, e=>{ clearTimeout(t); reject(e); });
      });
    }

    /* ---------------- 초기화 ---------------- */
    document.getElementById('nickname-input').addEventListener('keypress',(e)=>{ if(e.key==='Enter') startQuiz(); });
    document.addEventListener('DOMContentLoaded', async ()=>{
      renderTodayRanking('today-ranking');
      // 앱 기동 시 1회 워밍업 (결과 화면 즉시성 향상)
      NEWS_PROMISE = warmRSSCache();
      // 주기 갱신(백그라운드)
      setInterval(()=>ensureFreshRSS(), 120000);
    });
  </script>

  <!-- (Cloudflare script 유지) -->
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e71f0682b1aa47',t:'MTc1NTA3NjY2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
